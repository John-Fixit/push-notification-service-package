"use strict";function s(s){return s&&"object"==typeof s&&"default"in s?s:{default:s}}Object.defineProperty(exports,"__esModule",{value:!0});var t=s(require("web-push"));const i="BFtsHOr4nnMmA9zvImAR-XRXZ89IpppbjYaZ93L2YqkombTbXyhYXwMLJ9BnChssfIcoS6P4LYp-W1G7pqdk-RQ",e="7JgjG-jzXykKfbpt7XtZa6Po_e1siUA_65B0jAaMBx8";exports.PushNotificationServer=class{constructor(s){this.publicKey=s.publicKey,this.privateKey=s.privateKey,this.email=s.email,this.subscriptions=new Map,console.log(this.subscriptions),t.default.setVapidDetails(`mailto:${this.email||"jfixcoding@gmail"}`,this.publicKey||i,this.privateKey||e)}setupRoutes(s){s.post("/save-subscription",this.saveSubscription.bind(this)),s.post("/send-notification",this.sendNotification.bind(this)),s.get("/vapid-public-key",((s,t)=>{t.json({publicKey:this.publicKey||i})}))}saveSubscription(s,t){const{user:i,key:e}=s.body,o=e?.keys?.auth;console.log(this.subscriptions,o),this.subscriptions.has(e.endpoint)||this.subscriptions.set(e.endpoint,{userAuth:o,key:e}),t.status(200).json({status:"success",message:"Subscription saved!"})}async sendNotification(s,i){const e=s.body;if(console.log(this.subscriptions,e),0===this.subscriptions.size)return i.status(400).json({status:"error",message:"No subscriptions found"});try{const s=await Promise.all(Array.from(this.subscriptions.values()).map((s=>t.default.sendNotification(s.key,JSON.stringify(e)).then((()=>({success:!0}))).catch((s=>({success:!1,error:s.message})))))),o=s.filter((s=>s.success)).length,n=s.length-o;i.status(200).json({status:"success",message:`Notifications sent! Success: ${o}, Failures: ${n}`})}catch(s){i.status(500).json({status:"error",message:"Internal server error"})}}};
